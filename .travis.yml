language: python
python:
  - "2.7"
  - "3.4"
addons:
  postgresql: "9.3"
services:
  - memcached
before_install:
  - sudo apt-get update
  # Remove python-zope.interface, not compatible with the pyramid version we're
  # using
  - sudo apt-get remove python-zope.interface
  # Install the 'plpython' extension language
  - sudo apt-get install postgresql-plpython-9.3
  # Install the 'plxslt' extension language
  - sudo apt-get install libxml2-dev libxslt-dev postgresql-server-dev-9.3
  - git clone https://github.com/petere/plxslt.git
  - cd plxslt && sudo make && sudo make install && cd ..

  # Install rhaptos.cnxmlutils (dependency of cnx-cnxml-transforms)
  - git clone https://github.com/Connexions/rhaptos.cnxmlutils.git
  - cd ./rhaptos.cnxmlutils && python setup.py install && sudo /usr/bin/python setup.py install && cd ..
  # Install cnx-cnxml-transforms
  - git clone https://github.com/Connexions/cnx-cnxml-transforms.git
  - cd ./cnx-cnxml-transforms && python setup.py install && sudo /usr/bin/python setup.py install && cd ..
  # Install cnx-query-grammar
  - git clone https://github.com/Connexions/cnx-query-grammar.git
  - cd ./cnx-query-grammar && python setup.py install && cd ..
  # Install cnx-epub
  - git clone https://github.com/Connexions/cnx-epub.git
  - cd ./cnx-epub && python setup.py install && cd ..

  # Install the coverage utility and coveralls reporting utility
  - pip install coverage
  - pip install coveralls

# Doesn't work with python 3
#  # FIXME patch triggers to include paths to cnx-cnxml-transforms and rhaptos.cnxmlutils
#  - CNXML_TRANSFORMS_PATH=$(python -c 'import os; import cnxmltransforms; print(os.path.abspath("{}/..".format(cnxmltransforms.__path__[0])))')
#  - RHAPTOS_CNXMLUTILS_PATH=$(python -c 'import os; import rhaptos.cnxmlutils; print(os.path.abspath("{}/../..".format(rhaptos.cnxmlutils.__path__[0])))')
#  - LXML_PATH=$(python -c 'import os; import lxml; print(os.path.abspath("{}/..".format(lxml.__path__[0])))')
#  - cd cnx-cnxml-transforms && python setup.py install && cd ..
#  - sed -i "s%from cnxmltransforms%import sys; sys.path.append('$CNXML_TRANSFORMS_PATH'); sys.path.append('$RHAPTOS_CNXMLUTILS_PATH'); sys.path.append('$LXML_PATH'); &%" cnxarchive/sql/schema/*.sql
install:
  - python setup.py install
before_script:
  # Set up postgres roles
  - sudo -u postgres psql -d postgres -c "CREATE USER cnxarchive WITH SUPERUSER PASSWORD 'cnxarchive';"
  # Set up the database
  - sudo -u postgres createdb -O cnxarchive cnxarchive-testing
  - pip install pep8
  - pep8 --exclude=tests *.py cnxarchive/
  - pep8 --max-line-length=200 cnxarchive/tests

script:
  # This is the same as `python setup.py test` with a coverage wrapper.
  - coverage run --source=cnxarchive setup.py test
after_success:
  # Report test coverage to coveralls.io
  - coveralls
notifications:
  email: false
